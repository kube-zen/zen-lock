apiVersion: v1
kind: Namespace
metadata:
  name: zen-lock-system
---
apiVersion: v1
kind: Service
metadata:
  name: zen-lock-webhook
  namespace: zen-lock-system
spec:
  ports:
    - port: 443
      targetPort: 9443
  selector:
    app: zen-lock-webhook
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zen-lock-webhook
  namespace: zen-lock-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zen-lock-webhook
  template:
    metadata:
      labels:
        app: zen-lock-webhook
    spec:
      serviceAccountName: zen-lock-webhook
      # Note: This deployment runs only the webhook component
      # The controller runs in a separate deployment with zen-lock-controller ServiceAccount
      containers:
        - name: webhook
          args:
            - --cert-dir=/tmp/k8s-webhook-server/serving-certs
            - --metrics-bind-address=:8080
            - --health-probe-bind-address=:8081
            - --enable-controller=false
            - --enable-webhook=true
          image: kube-zen/zen-lock-webhook:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: ZEN_LOCK_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: zen-lock-master-key
                  key: key.txt
          ports:
            - containerPort: 9443
              name: webhook
              protocol: TCP
            - containerPort: 8080
              name: metrics
              protocol: TCP
            - containerPort: 8081
              name: health
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8081
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8081
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: zen-lock-mutating-webhook
  annotations:
    cert-manager.io/inject-ca-from: zen-lock-system/zen-lock-webhook-cert
webhooks:
  - name: mutate-pods.zen-lock.security.kube-zen.io
    clientConfig:
      service:
        name: zen-lock-webhook
        namespace: zen-lock-system
        path: "/mutate-pods"
    rules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["pods"]
    admissionReviewVersions: ["v1", "v1beta1"]
    sideEffects: NoneOnDryRun
    failurePolicy: Fail
    timeoutSeconds: 10
    namespaceSelector:
      matchLabels:
        zen-lock: enabled
